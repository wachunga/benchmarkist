<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Transact</title>
	<link rel="stylesheet" href="main.css">
</head>
<body>
	<nav class="main-nav">
		<div>Bench Test</div>
	</nav>
	<div class="container">

		<section class="expenses">
			<h1 class="section-header" id="expenses">Expenses <span class="expense-count"></span></h1>
			<table class="sum-table">
				<colgroup>
					<col class="col-category">
				</colgroup>
				<thead>
					<th>Category</th>
					<th>Total</th>
					<th>Percent</th>
				</thead>
				<tbody class="expenses-table-body">
					<tr>
						<td colspan="3">Loading...</td>
					</tr>
				</tbody>
			</table>
		</section>

		<section class="transactions">
			<h1 class="section-header" id="transactions">Transactions <span class="transaction-count"></span></h1>
			<table class="sum-table">
				<thead>
					<th>Date</th>
					<th>Company</th>
					<th>Account</th>
					<th class="transaction-table-total"></th>
				</thead>
				<tbody class="transaction-table-body">
					<tr>
						<td colspan="4">Loading...</td>
					</tr>
				</tbody>
			</table>
		</section>
	</div>

<script>

	const expensesSummaryElement = document.querySelector('.expenses-table-body');

	fetchExpenses().then(showExpenses);

	function fetchExpenses() {
		return fetch('/a/1/expenses?formatted=true&dedupe=true')
			.then(function (response) {
				return response.json();
			});
	}

	function showExpenses(results) {
		expensesSummaryElement.innerHTML = results.map(buildExpenseEntry).join('\n')
	}

	function buildExpenseEntry(expense) {
		const detailsTableRows = expense.transactions.map(transaction => {
			return `<tr><td>${transaction.Date}</td><td>${transaction.Company}</td><td>${transaction.Amount}</td></tr>`;
		}).join('\n');
		const detailsTable = `<table class="expense-details-table"><tbody>${detailsTableRows}</tbody></table>`;
		const detailsElement = `<details><summary>${expense.categoryKey}</summary>${detailsTable}</details>`;
		return `<tr><td>${detailsElement}</td><td>${expense.total}</td><td></td></tr>`;
	}
</script>

<script>
	if (!fetch) {
		alert('Your browser is currently unsupported');
	}

	const transactionCountElement = document.querySelector('.transaction-count');
	const transactionTableBodyElement = document.querySelector('.transaction-table-body');
	const transactionTotalElement = document.querySelector('.transaction-table-total');

	fetchTransactions().then(addResults);

	function fetchTransactions() {
		return fetch('/a/1/transactions?formatted=true&dedupe=true')
			.then(function (response) {
				return response.json();
			});
	}

	function addResults(results) {
		transactionTotalElement.innerText = results.totalBalance;
		transactionCountElement.innerText = `(${results.transactions.length})`;
		transactionTableBodyElement.innerHTML = results.transactions.map(makeTransactionTableRow).join('\n');
	}

	function makeTransactionTableRow(result) {
		const rowClass = 'row-' + result.Ledger.toLowerCase();
		return `
<tr class="${rowClass}">
	<td>${result.Date}</td>
	<td>${result.Company}</td>
	<td>${result.Ledger}</td>
	<td>${result.Amount}</td>
</tr>`;
	}

</script>
</body>
</html>
